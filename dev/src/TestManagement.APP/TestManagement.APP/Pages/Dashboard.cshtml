@page
@model DashboardModel
@{
    ViewData["Title"] = "開発者向けダッシュボード";
}

<div class="container">

    <div class="block">
        <div class="block-title">プロジェクトサマリ</div>
        <!-- プロジェクトサマリ -->
        <div class="summary-row d-flex flex-row align-items-stretch" style="gap:0;">
            <div class="summary-col" style="flex:0 0; max-width:50%; display:flex; padding:0; margin: 0 16px 0 0;">
                <div class="chart-card d-flex align-items-center justify-content-center flex-fill" style="padding:0; margin:0;">
                    <canvas id="summaryChart" aria-label="成功率と実行件数の円グラフ" style="display:block; width:100%; height:100%; padding:8px;"></canvas>
                </div>
            </div>

            <div class="summary-col" style="flex:0 0 20%; max-width:50%; display:flex; flex-direction:column; padding:0;">
                <div class="card" style="margin:0 0 8px 0; border:0;">
                    <div class="card-title">成功率</div>
                    <div class="card-value">@Model.GetPassRatePercent()</div>
                </div>

                <div class="card" style="margin:8px 0 0 0; border:0;">
                    <div class="card-title">実行件数</div>
                    <div class="card-value">@Model.Summary?.ExecutedNum 件</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 最近の実行結果 -->
    <div class="block">
        <div class="block-title">最近の実行結果</div>


        @* 先頭に TestRun の概要を表示 *@
        @if (Model.TestRun != null && Model.TestRun.Id != 0)
        {
            <div class="card" style="display:inline-block; width:auto; max-width:100%; margin-bottom:12px;">
                <div class="card-title">テスト実行情報</div>
                <div>実行ID: <strong>@Model.TestRun.Id</strong></div>
                <div>実行日時: <strong>@Model.TestRun.ExecutedAt.ToString("yyyy/MM/dd")</strong></div>
                @if (!string.IsNullOrEmpty(Model.TestRun.Environment) && (!string.IsNullOrWhiteSpace(Model.TestRun.Environment)))
                {
                    <div>環境: <strong>@Model.TestRun.Environment</strong></div>
                }
                @if (!string.IsNullOrWhiteSpace(Model.TestRun.Notes))
                {
                    <div style="margin-top:6px;">備考: <span>@Model.TestRun.Notes</span></div>
                }
            </div>
        }

        @if (Model.TestResults == null || !Model.TestResults.Any())
        {
            <div>データがありません。</div>
        }
        else
        {
            <table class="table-header-center">
                <thead>
                    <tr>
                        <th>実行日</th>
                        <th>ID</th>
                        <th>名前</th>
                        <th>実行結果</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var tr in Model.GetTestResultsToDisplay())
                    {
                        var statusClass = tr.Status == TestManagement.APP.Models.TestStatus.Success ? "status-success"
                            : tr.Status == TestManagement.APP.Models.TestStatus.Failure ? "status-failure"
                            : "status-skipped";

                        <tr>
                            <td class="text-center">@tr.ExecutedAt.ToString("yyyy/MM/dd hh:mm:ss")</td>
                            <td class="col-right">@tr.TestCaseId</td>
                            <td>@tr.TestCase!.Title</td>
                            <td class="@statusClass text-center">@tr.Status.ToString()</td>
                        </tr>
                    }
                </tbody>
            </table>
        }
    </div>

    @* ページ下部：ファイル選択画面への遷移ボタンとアップロード結果通知 *@
    <div class="page-footer">
        @if (TempData["UploadMessage"] is string msg)
        {
            <div class="notice">@msg</div>
        }
        <div style="margin-top:8px;">
        <a asp-page="/TestRuns/Index" class="upload-btn" style="margin-right:8px;">テスト実行一覧</a>
        <a asp-page="/TestCases/Index" class="upload-btn" style="margin-right:8px;">テストケース一覧</a>
        <a asp-page="/Upload" class="upload-btn">テスト実行結果の登録</a>
        </div>
    </div>
</div>

<script>
    (function() {
        // Summary counts from server
        const executed = @(Model.Summary?.ExecutedNum ?? 0);
        const errors = @(Model.Summary?.ErrorNum ?? 0);
        const success = Math.max(0, executed - errors);

        const ctx = document.getElementById('summaryChart');
        if (!ctx) return;

        const data = {
            labels: ['成功', '失敗'],
            datasets: [{
                data: [success, errors],
                backgroundColor: ['#2ecc71', '#e74c3c'],
                hoverOffset: 6
            }]
        };

        new Chart(ctx, {
            type: 'doughnut',
            data: data,
            options: {
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom' },
                    tooltip: { enabled: true }
                },
                cutout: '60%'
            }
        });
    })();
</script>
